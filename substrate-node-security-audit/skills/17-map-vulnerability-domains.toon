id: map-vulnerability-domains
version: 1.0.0
capability: "Map generic vulnerability classes (§3 categories) to specific codebase locations using architectural data from reconnaissance"

description: "Given the crate map, function registry, and trust boundaries from reconnaissance, this skill identifies which §3 vulnerability classes are triggered by the target codebase and where. The output is a structured domain map that replaces hardcoded target-specific rules with dynamically derived review targets. Sub-agents receive their crate's domain map entries instead of static rules."

inputs:
  crate_map:
    description: "Classification of crates by category and priority (from reconnaissance)"
    required: true
  function_registry:
    description: "Critical functions per crate (from reconnaissance)"
    required: true
  trust_boundaries:
    description: "Entry points for external data (from reconnaissance)"
    required: true
  target_profile:
    description: "Resource 06 — target-specific crate paths, config structs, cross-chain pallets"
    required: false

protocol:
  description: "For each §3 vulnerability class, determine whether the codebase exhibits the trigger pattern and where."
  steps[9]:
    - id: identify-persistence-patterns
      name: "§3.1 Targets: External Persistence in Hooks"
      description: "Identify pallets with on_finalize that call external persistence layers (e.g., flush, sync, commit). For each, record: pallet, hook, flush call sites, all state-modifying operations in execution order. These become §3.1 flush-ordering verification targets."
    - id: identify-lifecycle-patterns
      name: "§3.2 Targets: Storage Lifecycle Pairs"
      description: "Identify all StorageMap/StorageValue insert sites. For each, determine the expected inverse lifecycle event (e.g., create→spend, register→deregister). Record: map name, insert site, expected remove event, cursor/position storage values requiring monotonicity checks."
    - id: identify-partial-success-paths
      name: "§3.3 Targets: Partial-Success Event Emission"
      description: "Identify all deposit_event() call sites reachable from codepaths where partial success is possible (batch operations, multi-segment transactions). For each, record: event construction site, all collection fields on the event, the partial-success indicator."
    - id: identify-asymmetric-providers
      name: "§3.4 Targets: Proposer/Verifier Asymmetry"
      description: "Identify producer/consumer, proposer/verifier, or writer/reader pairs where the type sets or provider tuples may differ. For each, record: both type definitions, fields to diff, configuration structs feeding the providers."
    - id: identify-genesis-sources
      name: "§3.5 Targets: Genesis State Construction"
      description: "Identify all sites that construct genesis state, initial storage, or genesis block data. For each, record: construction function, data source (chain spec, hardcoded constant, embedded binary), reachable subcommands."
    - id: identify-trust-boundary-inputs
      name: "§3.6 Targets: Trust Boundary Input Types"
      description: "Enumerate all typed inputs at trust boundaries. For each, record: input type, structural validation present (length/bounds), semantic validation present (format/checksum/mathematical validity), consumption layer vs production layer."
    - id: identify-shared-resources
      name: "§3.8 Targets: Shared Resource Pools"
      description: "Identify all connection pools, thread pools, or shared resource pools. For each, record: creation site, max capacity, all consumers (trace clone() calls), whether any consumer is externally accessible (RPC, public API)."
    - id: identify-type-dispatchers
      name: "§3.14 Targets: Typed Enum Dispatch"
      description: "Identify all match statements over typed enums from external or deserialized data. For each, record: match site, whether a wildcard arm exists, what the wildcard does (reject vs accept-as-default)."
    - id: produce-domain-map
      name: Produce Vulnerability Domain Map
      description: "Compile all identified targets into a structured domain map: { vulnerability_class → [{ crate, location, trigger_pattern, verification_target }] }. Partition entries by crate for distribution to sub-agents."

output:
  description: "Structured domain map partitioned by crate, ready for sub-agent distribution."
  components[2]:
    - "Per-class target list: vulnerability_class, crate, location, trigger_pattern, verification_target"
    - "Per-crate partition: each crate's applicable domain map entries for inclusion in the sub-agent prompt"
