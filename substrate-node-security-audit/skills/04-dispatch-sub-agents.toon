id: dispatch-sub-agents
version: 1.2.0
capability: "Compose sub-agent Task prompts with workflow-server bootstrap instructions, context variables, and supplementary files; dispatch all agents concurrently"

description: "Defines the procedure for dispatching sub-agents during a multi-agent orchestrated workflow. The orchestrator provides the agent roster (IDs, activities, context); this skill defines how to compose the Task prompt, include bootstrap instructions, attach context variables and cross-scope supplementary files, and dispatch all agents concurrently in a single batch."

inputs[1]:
  - id: agent-roster
    description: "List of agents to dispatch, each with: agent_id, activity_id, context variables (e.g., crate_path, checklist_sections, function_registry), supplementary files"
    required: true

protocol:
  compose-prompts[1]:
    - "For each agent in the roster, build a Task prompt containing: (1) workflow-server bootstrap instructions — 'call get_rules() then call get_workflow_activity with the assigned activity_id, follow the activity steps sequentially'; (2) context variables — crate path, in_scope/out_of_scope, function registry entries; (3) supplementary cross-scope files — file paths from other crates needed for cross-boundary checks; (4) output format requirement — 'return structured output conforming to the output schema resource.'"
  dispatch-all[1]:
    - "Submit all agents in the roster as concurrent Task calls in a single batch. Each Task call uses the composed prompt from step 1."
  collect-all[1]:
    - "Wait for all agents to return. Collect structured output from each. If any agent fails or times out, record the failure and proceed with available results."
  verify-dispatch-completeness[1]:
    - "Compare the agent_roster (input) against the dispatched agent list. Every agent in the roster must have been dispatched and returned a result (success or failure). Produce a dispatch manifest table: agent_id, assigned_crate, dispatched (yes/no), returned (yes/no), status. If any agent was NOT dispatched, flag as INCOMPLETE and return the manifest to the orchestrator for remediation. Set agents_dispatched count. This step enforces the dispatch completeness gate."

output[1]:
  - id: dispatch-results
    description: "Collected results from all dispatched sub-agents."
    components:
      per_agent_output: "Per-agent structured output (conforming to the output schema resource)"
      dispatch_summary: "agents dispatched, failures encountered"
      dispatch_manifest: "per-agent table with assigned/dispatched/returned status"

tools:
  task:
    when: "Dispatching each sub-agent"
    params: "description, prompt, subagent_type, model"
    returns: "Sub-agent output text"

errors:
  agent_timeout:
    cause: "Sub-agent did not return within expected time"
    recovery: "Record timeout; proceed with available results; orchestrator decides whether to re-dispatch"
  incomplete_dispatch:
    cause: "One or more agents in the roster were not dispatched (e.g., skipped due to context pressure)"
    recovery: "Return INCOMPLETE status with the dispatch manifest. The orchestrator MUST dispatch the missing agents in a follow-up or flag the audit as incomplete. Do NOT proceed to structured-merge with missing agents."
