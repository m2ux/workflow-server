id: ensemble-pass
version: 2.1.0
name: Ensemble Pass
description: "Optional second-model audit run on priority-1/2 components. Merges findings with the primary report using union-with-consensus-severity strategy. Fully automated — no user checkpoints."
problem: Different models and configurations find different subsets of findings. Running the template a second time and merging results captures findings that are non-deterministically detected in any single run, improving overall coverage.
recognition[3]:
  - run ensemble pass
  - second model audit
  - multi-model merge
skills:
  primary: execute-audit
  supporting[1]:
    - score-severity
required: false
estimatedTime: 60-90m
rules[7]:
  - "This activity is OPTIONAL — only runs when ensemble_enabled is true"
  - "Scope the second pass to priority-1/2 components only to control cost"
  - "Use a different model or temperature if available; same model with different system prompt is acceptable"
  - "The merge strategy is union: include all findings from both runs, flag consensus vs single-source"
  - "EXECUTION VERIFICATION (v4.4): The ensemble pass MUST dispatch at least one sub-agent that independently applies the §3 checklist to priority-1/2 crates. Declaring the ensemble complete without dispatching any sub-agents violates this activity. The execute-second-pass step is the core of this activity — it is not optional."
  - "ARTIFACT REQUIREMENT (v4.4): The execute-second-pass step MUST produce a second-pass-findings artifact (MD or JSON) in the planning folder. This artifact is the verification mechanism — if it does not exist when the activity exits, the ensemble was not executed. The orchestrator checks for this artifact during the update-report step."
  - "CONTEXT CONSTRAINT HANDLING (v4.4): If context window pressure prevents executing a full second pass, the orchestrator MUST: (a) explicitly acknowledge the constraint, (b) scope the second pass to the top 3-5 files by priority rather than skipping entirely, and (c) produce the artifact even if the scope is reduced. A reduced-scope ensemble is always preferable to a skipped ensemble."
steps[4]:
  - id: configure-ensemble
    name: Configure Ensemble Run
    description: "Determine the scope (priority-1/2 components only), model configuration, and any prompt variations for the second pass."
  - id: execute-second-pass
    name: Execute Second Pass
    description: "Run the audit template against priority-1/2 components. The second pass follows the same §3 checklist and §5 execution requirements."
  - id: union-merge
    name: Union-Merge Findings
    skill: merge-findings
    skill_args:
      merge_strategy: union-merge
    description: "Merge second-pass findings with the primary report using union strategy."
  - id: update-report
    name: Update Report
    description: "Update 01-audit-report.md with ensemble results. Add a section noting which findings are consensus (both runs) vs single-source (one run only)."
decisions[1]:
  - id: next-phase
    name: Post-Ensemble Decision
    description: Route to gap analysis or completion
    branches[2]:
      - id: gap-analysis
        label: Run gap analysis
        condition:
          type: simple
          variable: has_reference_report
          operator: ==
          value: true
        transitionTo: gap-analysis
      - id: complete
        label: Audit complete
        isDefault: true
transitions[2]:
  - to: gap-analysis
    condition:
      type: simple
      variable: has_reference_report
      operator: ==
      value: true
  - to: gap-analysis
    isDefault: true
exitActions[1]{action,message}:
  log,Ensemble pass complete — findings merged with primary report
outcome[3]:
  - Second-pass findings merged with primary report
  - Findings classified as consensus or single-source
  - Escalated findings (PASS in primary, FAIL in ensemble) added
context_to_preserve[3]:
  - consensus_findings - Findings confirmed by both runs
  - single_source_findings - Findings from only one run
  - escalated_findings - PASSes in primary that became FAILs in ensemble
artifacts[1]:
  - id: second-pass-findings
    name: second-pass-findings.md
    location: planning
    description: "Raw findings from the second-pass audit run. Existence of this file verifies the ensemble was actually executed. Must contain at least one sub-agent dispatch result."
