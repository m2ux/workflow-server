{
  "$schema": "../../schemas/workflow.schema.json",
  "id": "work-package",
  "version": "1.0.0",
  "title": "Work Package Implementation Workflow",
  "description": "Defines how to plan and implement ONE work package from inception to merged PR. A work package is a discrete unit of work such as a feature, bug-fix, enhancement, refactoring, or any other deliverable change.",
  "author": "m2ux",
  "tags": ["implementation", "engineering", "workflow"],
  "rules": [
    "Agents must NOT proceed past checkpoints without user confirmation",
    "Ask, don't assume - Clarify requirements before acting",
    "Summarize, then proceed - Provide brief status before asking to continue",
    "One task at a time - Complete current work before starting new work",
    "Explicit approval - Get clear 'yes' or 'proceed' before major actions",
    "Decision points require user choice - When issues are found, user decides whether to proceed or loop back"
  ],
  "variables": [
    { "name": "issue_number", "type": "string", "description": "GitHub or Jira issue number" },
    { "name": "issue_platform", "type": "string", "description": "Issue tracking platform (github|jira)" },
    { "name": "pr_number", "type": "string", "description": "Pull request number" },
    { "name": "branch_name", "type": "string", "description": "Feature branch name" },
    { "name": "needs_elicitation", "type": "boolean", "description": "Whether requirements elicitation is needed", "defaultValue": false },
    { "name": "needs_research", "type": "boolean", "description": "Whether research phase is needed", "defaultValue": false },
    { "name": "is_architecturally_significant", "type": "boolean", "description": "Whether ADR is needed", "defaultValue": false },
    { "name": "validation_passed", "type": "boolean", "description": "Whether validation phase passed" },
    { "name": "review_passed", "type": "boolean", "description": "Whether strategic review passed" }
  ],
  "initialPhase": "phase-1-issue-verification",
  "phases": [
    {
      "id": "phase-1-issue-verification",
      "name": "Issue Verification & PR Creation",
      "description": "Every work package should be linked to a GitHub or Jira issue. Issues define the problem space and provide traceability from requirements through implementation.",
      "required": true,
      "estimatedTime": "10-20m",
      "guide": { "path": "work-package/work-package.md", "section": "Phase 1: Issue Verification & PR Creation" },
      "entryActions": [
        { "action": "log", "message": "Starting issue verification and PR creation" }
      ],
      "steps": [
        {
          "id": "step-1-1-check-issue",
          "name": "Check for Existing Issue",
          "description": "Verify whether an issue has been specified by user or in context",
          "guide": { "path": "work-package/work-package.md", "section": "1.1 Check for Existing Issue" }
        }
      ],
      "checkpoints": [
        {
          "id": "checkpoint-1-2-issue-verification",
          "name": "Issue Verification Checkpoint",
          "message": "I didn't find a GitHub or Jira issue associated with this work package. Which option would you like?",
          "guide": { "path": "work-package/work-package.md", "section": "1.2 ðŸ›‘ Issue Verification Checkpoint" },
          "options": [
            { "id": "provide-existing", "label": "Provide existing issue", "description": "Share the issue number or URL (GitHub #N or Jira PROJ-N)" },
            { "id": "create-github", "label": "Create GitHub issue", "description": "Draft one using the GitHub Issue Creation Guide", "effect": { "setVariable": { "issue_platform": "github" } } },
            { "id": "create-jira", "label": "Create Jira issue", "description": "Draft one using the Jira Issue Creation Guide", "effect": { "setVariable": { "issue_platform": "jira" } } },
            { "id": "skip-issue", "label": "Skip issue", "description": "Proceed without (not recommended for non-trivial work)" }
          ]
        },
        {
          "id": "checkpoint-1-4-issue-created",
          "name": "Issue Created Checkpoint",
          "message": "Issue created. Proceed to create feature branch and initial PR?",
          "guide": { "path": "work-package/work-package.md", "section": "1.4 ðŸ›‘ Issue Created Checkpoint" },
          "options": [
            { "id": "proceed", "label": "Proceed" },
            { "id": "modify", "label": "Modify issue first" }
          ]
        },
        {
          "id": "checkpoint-1-8-pr-created",
          "name": "PR Created Checkpoint",
          "message": "PR created and linked to issue. Do you need requirements elicitation?",
          "guide": { "path": "work-package/work-package.md", "section": "1.8 ðŸ›‘ PR Created Checkpoint" },
          "options": [
            { "id": "yes-elicit", "label": "Yes, elicit requirements", "description": "Proceed to Phase 2 (Requirements Elicitation)", "effect": { "setVariable": { "needs_elicitation": true } } },
            { "id": "no-skip", "label": "No, skip elicitation", "description": "Proceed to research decision", "effect": { "setVariable": { "needs_elicitation": false } } }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-2-requirements-elicitation", "condition": { "type": "simple", "variable": "needs_elicitation", "operator": "==", "value": true } },
        { "to": "phase-3-implementation-analysis", "condition": { "type": "simple", "variable": "needs_elicitation", "operator": "==", "value": false }, "isDefault": true }
      ],
      "exitActions": [
        { "action": "log", "message": "Phase 1 complete: Issue verified, PR created" }
      ]
    },
    {
      "id": "phase-2-requirements-elicitation",
      "name": "Requirements Elicitation",
      "description": "Discover and clarify what the work package should accomplish through structured conversation. This phase ensures requirements are explicitly captured before planning the approach.",
      "required": false,
      "estimatedTime": "15-30m",
      "guide": { "path": "work-package/requirements-elicitation.guide.md" },
      "steps": [
        {
          "id": "step-2-1-explore",
          "name": "Explore problem space",
          "description": "Explore problem through sequential conversation (one question at a time)"
        },
        {
          "id": "step-2-2-stakeholders",
          "name": "Identify stakeholders and context"
        },
        {
          "id": "step-2-3-scope",
          "name": "Define scope boundaries",
          "description": "Define in/out scope lists"
        },
        {
          "id": "step-2-4-criteria",
          "name": "Establish success criteria"
        },
        {
          "id": "step-2-5-document",
          "name": "Create requirements document",
          "description": "Create 00-requirements-elicitation.md"
        }
      ],
      "checkpoints": [
        {
          "id": "checkpoint-2-2-requirements-confirmed",
          "name": "Requirements Elicitation Checkpoint",
          "message": "Have I understood the requirements correctly?",
          "guide": { "path": "work-package/requirements-elicitation.guide.md", "section": "Checkpoint Template" },
          "options": [
            { "id": "confirmed", "label": "Requirements confirmed" },
            { "id": "clarify", "label": "Need clarification" }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-3-implementation-analysis", "isDefault": true }
      ]
    },
    {
      "id": "phase-3-implementation-analysis",
      "name": "Implementation Analysis",
      "description": "Analyze the current implementation to understand effectiveness, establish baselines, and identify opportunities for improvement.",
      "required": true,
      "estimatedTime": "10-20m",
      "guide": { "path": "work-package/implementation-analysis.guide.md" },
      "steps": [
        {
          "id": "step-3-1-analyze",
          "name": "Complete implementation analysis",
          "guide": { "path": "work-package/implementation-analysis.guide.md" }
        },
        {
          "id": "step-3-2-document",
          "name": "Create analysis document",
          "description": "Create 01-implementation-analysis.md"
        }
      ],
      "checkpoints": [
        {
          "id": "checkpoint-3-1-research-decision",
          "name": "Research Decision Checkpoint",
          "message": "Implementation analysis complete. Would you like to perform research?",
          "guide": { "path": "work-package/implementation-analysis.guide.md", "section": "Checkpoint Template" },
          "options": [
            { "id": "yes-research", "label": "Yes, perform research", "effect": { "setVariable": { "needs_research": true } } },
            { "id": "no-skip", "label": "No, skip research", "effect": { "setVariable": { "needs_research": false } } }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-4-research", "condition": { "type": "simple", "variable": "needs_research", "operator": "==", "value": true } },
        { "to": "phase-5-plan-prepare", "condition": { "type": "simple", "variable": "needs_research", "operator": "==", "value": false }, "isDefault": true }
      ]
    },
    {
      "id": "phase-4-research",
      "name": "Research",
      "description": "Research the knowledge base and external sources to discover best practices, patterns, and resources to inform the planning phase.",
      "required": false,
      "estimatedTime": "20-45m",
      "guide": { "path": "work-package/knowledge-base-research.guide.md" },
      "steps": [
        {
          "id": "step-4-1-kb-research",
          "name": "Knowledge base research",
          "description": "Call get_guidance before making concept-rag MCP tool calls",
          "guide": { "path": "work-package/knowledge-base-research.guide.md" }
        },
        {
          "id": "step-4-2-web-research",
          "name": "Web research",
          "description": "Search web for current information"
        },
        {
          "id": "step-4-3-document",
          "name": "Create research document",
          "description": "Create 02-kb-research.md"
        }
      ],
      "checkpoints": [
        {
          "id": "checkpoint-4-1-kb-insights",
          "name": "Knowledge Base Insights Checkpoint",
          "message": "Knowledge insights confirmed?",
          "options": [
            { "id": "confirmed", "label": "Insights confirmed" },
            { "id": "more-research", "label": "Need more research" }
          ]
        },
        {
          "id": "checkpoint-4-2-web-research",
          "name": "Web Research Checkpoint",
          "message": "Web research findings confirmed?",
          "options": [
            { "id": "confirmed", "label": "Findings confirmed" },
            { "id": "more-research", "label": "Need more research" }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-5-plan-prepare", "isDefault": true }
      ]
    },
    {
      "id": "phase-5-plan-prepare",
      "name": "Plan & Prepare",
      "description": "Design the approach, create the work package plan, and prepare for implementation.",
      "required": true,
      "estimatedTime": "20-45m",
      "guide": { "path": "work-package/plan.guide.md" },
      "steps": [
        {
          "id": "step-5-1-design",
          "name": "Apply design framework",
          "guide": { "path": "work-package/design-framework.guide.md" }
        },
        {
          "id": "step-5-2-create-plan",
          "name": "Create work package plan",
          "guide": { "path": "work-package/plan.guide.md" }
        },
        {
          "id": "step-5-3-test-plan",
          "name": "Create test plan",
          "guide": { "path": "work-package/test-plan.guide.md" }
        },
        {
          "id": "step-5-4-sync-branch",
          "name": "Sync feature branch with main"
        },
        {
          "id": "step-5-5-update-pr",
          "name": "Update PR description",
          "guide": { "path": "work-package/pr-description.guide.md" }
        },
        {
          "id": "step-5-6-create-todos",
          "name": "Create TODO list from plan"
        }
      ],
      "checkpoints": [
        {
          "id": "checkpoint-5-2-approach-confirmed",
          "name": "Approach Checkpoint",
          "message": "Approach confirmed?",
          "guide": { "path": "work-package/plan.guide.md", "section": "Checkpoint Template" },
          "options": [
            { "id": "confirmed", "label": "Approach confirmed" },
            { "id": "revise", "label": "Revise approach" }
          ]
        },
        {
          "id": "checkpoint-5-4-ready-implement",
          "name": "Ready to Implement Checkpoint",
          "message": "Ready to implement?",
          "options": [
            { "id": "ready", "label": "Ready to implement" },
            { "id": "not-ready", "label": "Not ready, need more preparation" }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-6-implement", "isDefault": true }
      ]
    },
    {
      "id": "phase-6-implement",
      "name": "Implement Tasks",
      "description": "Execute the implementation plan task by task. Each task follows a cycle of implement â†’ test â†’ commit â†’ review assumptions â†’ checkpoint.",
      "required": true,
      "estimatedTime": "1-4h",
      "guide": { "path": "work-package/work-package.md", "section": "Phase 6: Implement Tasks" },
      "entryActions": [
        { "action": "validate", "target": "branch", "message": "Verify on correct feature branch before any code changes" }
      ],
      "loops": [
        {
          "id": "loop-6-1-task-cycle",
          "name": "Task Implementation Cycle",
          "type": "forEach",
          "variable": "current_task",
          "over": "plan.tasks",
          "steps": [
            { "id": "step-6-1-implement", "name": "Implement task" },
            { "id": "step-6-2-test", "name": "Run tests" },
            { "id": "step-6-3-commit", "name": "Commit changes" },
            { "id": "step-6-4-assumptions", "name": "Review assumptions", "guide": { "path": "work-package/assumptions-review.guide.md" } }
          ]
        }
      ],
      "checkpoints": [
        {
          "id": "checkpoint-6-2-task-progress",
          "name": "Task Progress Checkpoint",
          "message": "Task complete. Assumptions confirmed?",
          "guide": { "path": "work-package/assumptions-review.guide.md", "section": "Checkpoint Template" },
          "options": [
            { "id": "confirmed", "label": "Assumptions confirmed" },
            { "id": "correction", "label": "Need correction" }
          ]
        },
        {
          "id": "checkpoint-6-3-code-review",
          "name": "Code Review Checkpoint",
          "message": "Review findings confirmed?",
          "guide": { "path": "work-package/task-completion-review.guide.md", "section": "Checkpoint Template" },
          "options": [
            { "id": "confirmed", "label": "Findings confirmed" },
            { "id": "needs-fixes", "label": "Needs fixes" }
          ]
        },
        {
          "id": "checkpoint-6-4-arch-significance",
          "name": "Architectural Significance Checkpoint",
          "message": "Significance assessment confirmed?",
          "guide": { "path": "work-package/architecture-review.guide.md", "section": "Checkpoint Template" },
          "options": [
            { "id": "significant", "label": "Architecturally significant - create ADR", "effect": { "setVariable": { "is_architecturally_significant": true } } },
            { "id": "not-significant", "label": "Not significant", "effect": { "setVariable": { "is_architecturally_significant": false } } }
          ]
        },
        {
          "id": "checkpoint-6-5-adr",
          "name": "ADR Checkpoint",
          "message": "ADR confirmed?",
          "guide": { "path": "work-package/architecture-review.guide.md", "section": "ADR Template" },
          "required": false,
          "options": [
            { "id": "confirmed", "label": "ADR confirmed" },
            { "id": "revise", "label": "Revise ADR" }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-7-validate", "isDefault": true }
      ]
    },
    {
      "id": "phase-7-validate",
      "name": "Verify & Validate Design",
      "description": "Validate the implementation through comprehensive testing. All tests must pass before the work package is considered complete.",
      "required": true,
      "estimatedTime": "30-60m",
      "guide": { "path": "work-package/test-plan.guide.md" },
      "steps": [
        { "id": "step-7-1-run-tests", "name": "Run all tests", "description": "Unit, integration, e2e tests" },
        { "id": "step-7-2-build", "name": "Verify build succeeds" },
        { "id": "step-7-3-lint", "name": "Check for linter errors" }
      ],
      "decisions": [
        {
          "id": "decision-7-2-validation",
          "name": "Validation Decision",
          "description": "Assess validation results and decide next action",
          "guide": { "path": "work-package/work-package.md", "section": "7.2 ðŸ”€ Validation Decision Point" },
          "branches": [
            { "id": "pass", "label": "Pass - All tests pass, build succeeds", "transitionTo": "phase-8-review", "condition": { "type": "simple", "variable": "validation_passed", "operator": "==", "value": true } },
            { "id": "minor-issues", "label": "Minor issues - Isolated failures, localized bugs", "transitionTo": "phase-6-implement" },
            { "id": "major-issues", "label": "Major issues - Fundamental design problems", "transitionTo": "phase-5-plan-prepare", "isDefault": true }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-8-review", "condition": { "type": "simple", "variable": "validation_passed", "operator": "==", "value": true } },
        { "to": "phase-6-implement", "isDefault": true }
      ]
    },
    {
      "id": "phase-8-review",
      "name": "Strategic Review",
      "description": "Review the implementation to ensure changes are minimal and focused. Validates that the final PR contains only the changes required for the solution.",
      "required": true,
      "estimatedTime": "15-30m",
      "guide": { "path": "work-package/strategic-review.guide.md" },
      "steps": [
        { "id": "step-8-1-review", "name": "Complete strategic review", "guide": { "path": "work-package/strategic-review.guide.md" } }
      ],
      "checkpoints": [
        {
          "id": "checkpoint-8-1-review-findings",
          "name": "Strategic Review Checkpoint",
          "message": "Review findings confirmed?",
          "guide": { "path": "work-package/strategic-review.guide.md", "section": "Checkpoint Template" },
          "options": [
            { "id": "confirmed", "label": "Findings confirmed" },
            { "id": "needs-cleanup", "label": "Needs cleanup" }
          ]
        }
      ],
      "decisions": [
        {
          "id": "decision-8-2-review",
          "name": "Strategic Review Decision",
          "description": "Assess whether issues require re-planning",
          "guide": { "path": "work-package/work-package.md", "section": "8.2 ðŸ”€ Strategic Review Decision Point" },
          "branches": [
            { "id": "pass", "label": "Pass - Changes are minimal and focused", "transitionTo": "phase-9-finalize", "condition": { "type": "simple", "variable": "review_passed", "operator": "==", "value": true } },
            { "id": "issues", "label": "Issues found - Significant rework needed", "transitionTo": "phase-5-plan-prepare", "isDefault": true }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-9-finalize", "condition": { "type": "simple", "variable": "review_passed", "operator": "==", "value": true } },
        { "to": "phase-5-plan-prepare", "isDefault": true }
      ]
    },
    {
      "id": "phase-9-finalize",
      "name": "Finalize",
      "description": "Finalize documentation after implementation is complete.",
      "required": true,
      "estimatedTime": "15-30m",
      "steps": [
        { "id": "step-9-1-adr", "name": "Update ADR status to Accepted", "description": "If ADR exists" },
        { "id": "step-9-2-test-plan", "name": "Finalize test plan with source links", "guide": { "path": "work-package/test-plan.guide.md" } },
        { "id": "step-9-3-complete", "name": "Create COMPLETE.md", "guide": { "path": "work-package/complete.guide.md" } },
        { "id": "step-9-4-docs", "name": "Ensure inline documentation on public APIs" }
      ],
      "transitions": [
        { "to": "phase-10-update-pr", "isDefault": true }
      ]
    },
    {
      "id": "phase-10-update-pr",
      "name": "Update PR",
      "description": "Update the PR with final implementation details and mark ready for review.",
      "required": true,
      "estimatedTime": "10-15m",
      "guide": { "path": "work-package/pr-description.guide.md" },
      "steps": [
        { "id": "step-10-1-push", "name": "Push all commits" },
        { "id": "step-10-2-update-pr", "name": "Update PR description", "guide": { "path": "work-package/pr-description.guide.md" } },
        { "id": "step-10-3-ready", "name": "Mark PR ready for review" }
      ],
      "checkpoints": [
        {
          "id": "checkpoint-10-2-pr-description",
          "name": "PR Update Checkpoint",
          "message": "PR description confirmed?",
          "guide": { "path": "work-package/pr-description.guide.md", "section": "Checkpoint Template" },
          "options": [
            { "id": "confirmed", "label": "PR description confirmed" },
            { "id": "revise", "label": "Revise PR description" }
          ]
        }
      ],
      "transitions": [
        { "to": "phase-11-post-implementation", "isDefault": true }
      ]
    },
    {
      "id": "phase-11-post-implementation",
      "name": "Post-Implementation",
      "description": "Complete post-implementation tasks after the PR is created.",
      "required": true,
      "estimatedTime": "10-20m",
      "guide": { "path": "work-package/workflow-retrospective.guide.md" },
      "steps": [
        { "id": "step-11-1-history", "name": "Capture session history", "description": "If metadata repository exists - private, never committed" },
        { "id": "step-11-2-retro", "name": "Workflow retrospective", "guide": { "path": "work-package/workflow-retrospective.guide.md" }, "description": "Skip if trivial session" },
        { "id": "step-11-3-status", "name": "Update work package plan status", "description": "After PR merged" },
        { "id": "step-11-4-next", "name": "Select next work package" }
      ],
      "exitActions": [
        { "action": "log", "message": "Work package workflow complete" }
      ]
    }
  ]
}
