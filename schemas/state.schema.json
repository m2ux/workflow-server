{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "state",
  "description": "Workflow state schema - uses numeric indices for phases/steps to eliminate redundancy",
  "$ref": "#/definitions/state",
  "definitions": {
    "state": {
      "type": "object",
      "properties": {
        "workflowId": {
          "type": "string",
          "description": "ID of the workflow being executed"
        },
        "workflowVersion": {
          "type": "string",
          "description": "Version of the workflow"
        },
        "stateVersion": {
          "type": "integer",
          "exclusiveMinimum": 0,
          "default": 1,
          "description": "State schema version for migration support"
        },
        "startedAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "completedAt": {
          "type": "string",
          "format": "date-time"
        },
        "currentPhase": {
          "type": "integer",
          "minimum": 1,
          "description": "Current phase index (1-based)"
        },
        "currentStep": {
          "type": "integer",
          "minimum": 1,
          "description": "Current step index within current phase (1-based)"
        },
        "completedPhases": {
          "type": "array",
          "items": {
            "type": "integer",
            "minimum": 1
          },
          "default": [],
          "description": "Array of completed phase indices"
        },
        "skippedPhases": {
          "type": "array",
          "items": {
            "type": "integer",
            "minimum": 1
          },
          "default": [],
          "description": "Array of skipped phase indices"
        },
        "completedSteps": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "integer",
              "minimum": 1
            }
          },
          "default": {},
          "description": "Map of phase index to array of completed step indices"
        },
        "checkpointResponses": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "optionId": {
                "type": "string",
                "description": "ID of the selected option"
              },
              "respondedAt": {
                "type": "string",
                "format": "date-time"
              },
              "effects": {
                "type": "object",
                "properties": {
                  "variablesSet": {
                    "type": "object",
                    "additionalProperties": {}
                  },
                  "transitionedTo": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Phase index transitioned to"
                  },
                  "phasesSkipped": {
                    "type": "array",
                    "items": {
                      "type": "integer",
                      "minimum": 1
                    }
                  }
                },
                "additionalProperties": false
              }
            },
            "required": ["optionId", "respondedAt"],
            "additionalProperties": false,
            "description": "Key is 'phaseIndex-checkpointIndex' (e.g., '1-2')"
          },
          "default": {}
        },
        "decisionOutcomes": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "branchId": {
                "type": "string",
                "description": "ID of the branch taken"
              },
              "decidedAt": {
                "type": "string",
                "format": "date-time"
              },
              "transitionedTo": {
                "type": "integer",
                "minimum": 1,
                "description": "Phase index transitioned to"
              }
            },
            "required": ["branchId", "decidedAt", "transitionedTo"],
            "additionalProperties": false,
            "description": "Key is 'phaseIndex-decisionIndex' (e.g., '7-2')"
          },
          "default": {}
        },
        "activeLoops": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "phaseIndex": {
                "type": "integer",
                "minimum": 1,
                "description": "Phase containing this loop"
              },
              "loopIndex": {
                "type": "integer",
                "minimum": 1,
                "description": "Index of the loop within the phase"
              },
              "currentIteration": {
                "type": "integer",
                "minimum": 0
              },
              "totalItems": {
                "type": "integer",
                "minimum": 0
              },
              "currentItem": {},
              "startedAt": {
                "type": "string",
                "format": "date-time"
              }
            },
            "required": ["phaseIndex", "loopIndex", "currentIteration", "startedAt"],
            "additionalProperties": false
          },
          "default": []
        },
        "variables": {
          "type": "object",
          "additionalProperties": {},
          "default": {}
        },
        "history": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time"
              },
              "type": {
                "type": "string",
                "enum": [
                  "workflow_started",
                  "workflow_completed",
                  "workflow_aborted",
                  "phase_entered",
                  "phase_exited",
                  "phase_skipped",
                  "step_started",
                  "step_completed",
                  "checkpoint_reached",
                  "checkpoint_response",
                  "decision_reached",
                  "decision_branch_taken",
                  "loop_started",
                  "loop_iteration",
                  "loop_completed",
                  "loop_break",
                  "variable_set",
                  "error"
                ]
              },
              "phase": {
                "type": "integer",
                "minimum": 1,
                "description": "Phase index"
              },
              "step": {
                "type": "integer",
                "minimum": 1,
                "description": "Step index within phase"
              },
              "checkpoint": {
                "type": "integer",
                "minimum": 1,
                "description": "Checkpoint index within phase"
              },
              "decision": {
                "type": "integer",
                "minimum": 1,
                "description": "Decision index within phase"
              },
              "loop": {
                "type": "integer",
                "minimum": 1,
                "description": "Loop index within phase"
              },
              "data": {
                "type": "object",
                "additionalProperties": {}
              },
              "error": {
                "type": "object",
                "properties": {
                  "message": {
                    "type": "string"
                  },
                  "code": {
                    "type": "string"
                  }
                },
                "required": ["message"],
                "additionalProperties": false
              }
            },
            "required": ["timestamp", "type"],
            "additionalProperties": false
          },
          "default": []
        },
        "status": {
          "type": "string",
          "enum": ["running", "paused", "completed", "aborted", "error"],
          "default": "running"
        },
        "lastError": {
          "type": "object",
          "properties": {
            "message": {
              "type": "string"
            },
            "code": {
              "type": "string"
            },
            "phase": {
              "type": "integer",
              "minimum": 1,
              "description": "Phase index where error occurred"
            },
            "step": {
              "type": "integer",
              "minimum": 1,
              "description": "Step index where error occurred"
            },
            "timestamp": {
              "type": "string",
              "format": "date-time"
            }
          },
          "required": ["message", "timestamp"],
          "additionalProperties": false
        }
      },
      "required": ["workflowId", "workflowVersion", "startedAt", "updatedAt", "currentPhase"],
      "additionalProperties": false
    }
  }
}
