{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "state",
  "description": "Runtime workflow execution state. Tracks current position, completed work, user responses, variable values, and execution history. Supports nested workflow relationships.",
  "$ref": "#/definitions/state",
  "definitions": {
    "parentWorkflowRef": {
      "type": "object",
      "description": "Reference to the parent workflow that triggered this one",
      "properties": {
        "workflowId": {
          "type": "string",
          "description": "ID of the parent workflow"
        },
        "activityId": {
          "type": "string",
          "description": "Activity in the parent workflow that triggered this one"
        },
        "passedContext": {
          "type": "object",
          "additionalProperties": {},
          "description": "Context variables passed from the parent workflow"
        },
        "returnTo": {
          "type": "object",
          "description": "Where to resume in the parent workflow after this one completes",
          "properties": {
            "activityId": {
              "type": "string",
              "description": "Activity ID to return to in the parent workflow"
            },
            "stepIndex": {
              "type": "integer",
              "minimum": 1,
              "description": "Step index to resume at within the return activity (1-based)"
            }
          },
          "required": ["activityId"],
          "additionalProperties": false
        }
      },
      "required": ["workflowId", "activityId"],
      "additionalProperties": false
    },
    "triggeredWorkflowRef": {
      "type": "object",
      "description": "Reference to a child workflow triggered from this one",
      "properties": {
        "workflowId": {
          "type": "string",
          "description": "ID of the triggered child workflow"
        },
        "triggeredAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when the child workflow was triggered"
        },
        "triggeredFrom": {
          "type": "object",
          "description": "Location in this workflow where the trigger occurred",
          "properties": {
            "activityId": {
              "type": "string",
              "description": "Activity that contains the trigger"
            },
            "stepIndex": {
              "type": "integer",
              "minimum": 1,
              "description": "Step index that triggered the child workflow (1-based)"
            }
          },
          "required": ["activityId"],
          "additionalProperties": false
        },
        "status": {
          "type": "string",
          "enum": ["running", "completed", "aborted", "error"],
          "description": "Current status of the triggered child workflow"
        },
        "returnedContext": {
          "type": "object",
          "additionalProperties": {},
          "description": "Context variables returned by the child workflow after completion"
        }
      },
      "required": ["workflowId", "triggeredAt", "triggeredFrom", "status"],
      "additionalProperties": false
    },
    "state": {
      "type": "object",
      "properties": {
        "workflowId": {
          "type": "string",
          "description": "ID of the workflow being executed"
        },
        "workflowVersion": {
          "type": "string",
          "description": "Version of the workflow definition"
        },
        "stateVersion": {
          "type": "integer",
          "exclusiveMinimum": 0,
          "default": 1,
          "description": "State schema version for migration support"
        },
        "startedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when workflow execution started"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of the most recent state change"
        },
        "completedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when workflow completed (only present when status is completed)"
        },
        "currentActivity": {
          "type": "string",
          "description": "ID of the activity currently being executed"
        },
        "currentStep": {
          "type": "integer",
          "minimum": 1,
          "description": "Index of the current step within the current activity (1-based)"
        },
        "completedActivities": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [],
          "description": "Activity IDs that have been completed in execution order"
        },
        "skippedActivities": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [],
          "description": "Activity IDs that were skipped (via checkpoint effects or mode skipActivities)"
        },
        "completedSteps": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "integer",
              "minimum": 1
            }
          },
          "default": {},
          "description": "Map of activity ID to array of completed step indices (1-based) within that activity"
        },
        "checkpointResponses": {
          "type": "object",
          "description": "User responses to checkpoints. Key format: 'activityId-checkpointId'",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "optionId": {
                "type": "string",
                "description": "ID of the option the user selected"
              },
              "respondedAt": {
                "type": "string",
                "format": "date-time",
                "description": "Timestamp when the user responded"
              },
              "effects": {
                "type": "object",
                "description": "Side effects that were applied when the user selected this option",
                "properties": {
                  "variablesSet": {
                    "type": "object",
                    "additionalProperties": {},
                    "description": "Variables that were set as a result of the selection"
                  },
                  "transitionedTo": {
                    "type": "string",
                    "description": "Activity ID that was transitioned to as a result"
                  },
                  "activitiesSkipped": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Activity IDs that were skipped as a result"
                  }
                },
                "additionalProperties": false
              }
            },
            "required": ["optionId", "respondedAt"],
            "additionalProperties": false
          },
          "default": {}
        },
        "decisionOutcomes": {
          "type": "object",
          "description": "Outcomes of automated decisions. Key format: 'activityId-decisionId'",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "branchId": {
                "type": "string",
                "description": "ID of the branch that was taken"
              },
              "decidedAt": {
                "type": "string",
                "format": "date-time",
                "description": "Timestamp when the decision was evaluated"
              },
              "transitionedTo": {
                "type": "string",
                "description": "Activity ID that was transitioned to"
              }
            },
            "required": ["branchId", "decidedAt", "transitionedTo"],
            "additionalProperties": false
          },
          "default": {}
        },
        "activeLoops": {
          "type": "array",
          "description": "Currently executing loops (stack â€” innermost loop is last)",
          "items": {
            "type": "object",
            "properties": {
              "activityId": {
                "type": "string",
                "description": "Activity containing this loop"
              },
              "loopId": {
                "type": "string",
                "description": "ID of the loop construct"
              },
              "currentIteration": {
                "type": "integer",
                "minimum": 0,
                "description": "Current iteration number (0-based)"
              },
              "totalItems": {
                "type": "integer",
                "minimum": 0,
                "description": "Total items in the collection (forEach only)"
              },
              "currentItem": {
                "description": "Current item value from the collection being iterated"
              },
              "startedAt": {
                "type": "string",
                "format": "date-time",
                "description": "Timestamp when the loop started"
              }
            },
            "required": ["activityId", "loopId", "currentIteration", "startedAt"],
            "additionalProperties": false
          },
          "default": []
        },
        "variables": {
          "type": "object",
          "additionalProperties": {},
          "default": {},
          "description": "Current values of all workflow variables (set by defaults, checkpoint effects, or set actions)"
        },
        "history": {
          "type": "array",
          "description": "Chronological log of all execution events",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time",
                "description": "When this event occurred"
              },
              "type": {
                "type": "string",
                "enum": [
                  "workflow_started",
                  "workflow_completed",
                  "workflow_aborted",
                  "workflow_triggered",
                  "workflow_returned",
                  "workflow_suspended",
                  "activity_entered",
                  "activity_exited",
                  "activity_skipped",
                  "step_started",
                  "step_completed",
                  "checkpoint_reached",
                  "checkpoint_response",
                  "decision_reached",
                  "decision_branch_taken",
                  "loop_started",
                  "loop_iteration",
                  "loop_completed",
                  "loop_break",
                  "variable_set",
                  "error"
                ],
                "description": "Event type categorizing what happened"
              },
              "activity": {
                "type": "string",
                "description": "Activity ID where the event occurred"
              },
              "step": {
                "type": "integer",
                "minimum": 1,
                "description": "Step index where the event occurred (1-based)"
              },
              "checkpoint": {
                "type": "string",
                "description": "Checkpoint ID (for checkpoint events)"
              },
              "decision": {
                "type": "string",
                "description": "Decision ID (for decision events)"
              },
              "loop": {
                "type": "string",
                "description": "Loop ID (for loop events)"
              },
              "data": {
                "type": "object",
                "additionalProperties": {},
                "description": "Additional event-specific data (e.g., variable values set, branch taken)"
              },
              "error": {
                "type": "object",
                "description": "Error details (for error events)",
                "properties": {
                  "message": {
                    "type": "string",
                    "description": "Human-readable error message"
                  },
                  "code": {
                    "type": "string",
                    "description": "Machine-readable error code"
                  }
                },
                "required": ["message"],
                "additionalProperties": false
              }
            },
            "required": ["timestamp", "type"],
            "additionalProperties": false
          },
          "default": []
        },
        "status": {
          "type": "string",
          "enum": ["running", "paused", "suspended", "completed", "aborted", "error"],
          "default": "running",
          "description": "Current workflow status: running (active), paused (awaiting user input at checkpoint), suspended (waiting for triggered child workflow), completed (finished successfully), aborted (cancelled), error (failed)"
        },
        "parentWorkflow": {
          "$ref": "#/definitions/parentWorkflowRef",
          "description": "Reference to parent workflow if this was triggered by another workflow's activity"
        },
        "triggeredWorkflows": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/triggeredWorkflowRef"
          },
          "default": [],
          "description": "Child workflows triggered from this workflow"
        },
        "lastError": {
          "type": "object",
          "description": "Most recent error encountered during execution",
          "properties": {
            "message": {
              "type": "string",
              "description": "Human-readable error message"
            },
            "code": {
              "type": "string",
              "description": "Machine-readable error code"
            },
            "activity": {
              "type": "string",
              "description": "Activity ID where error occurred"
            },
            "step": {
              "type": "integer",
              "minimum": 1,
              "description": "Step index where error occurred (1-based)"
            },
            "timestamp": {
              "type": "string",
              "format": "date-time",
              "description": "When the error occurred"
            }
          },
          "required": ["message", "timestamp"],
          "additionalProperties": false
        }
      },
      "required": ["workflowId", "workflowVersion", "startedAt", "updatedAt", "currentActivity"],
      "additionalProperties": false
    }
  }
}
