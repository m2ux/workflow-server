{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "state",
  "description": "Workflow state schema - tracks activity execution with nested workflow support",
  "$ref": "#/definitions/state",
  "definitions": {
    "parentWorkflowRef": {
      "type": "object",
      "properties": {
        "workflowId": {
          "type": "string",
          "description": "ID of the parent workflow"
        },
        "activityId": {
          "type": "string",
          "description": "Activity that triggered this workflow"
        },
        "passedContext": {
          "type": "object",
          "additionalProperties": {},
          "description": "Context passed from parent"
        },
        "returnTo": {
          "type": "object",
          "properties": {
            "activityId": {
              "type": "string"
            },
            "stepIndex": {
              "type": "integer",
              "minimum": 1
            }
          },
          "required": ["activityId"],
          "additionalProperties": false
        }
      },
      "required": ["workflowId", "activityId"],
      "additionalProperties": false
    },
    "triggeredWorkflowRef": {
      "type": "object",
      "properties": {
        "workflowId": {
          "type": "string",
          "description": "ID of the triggered workflow"
        },
        "triggeredAt": {
          "type": "string",
          "format": "date-time"
        },
        "triggeredFrom": {
          "type": "object",
          "properties": {
            "activityId": {
              "type": "string"
            },
            "stepIndex": {
              "type": "integer",
              "minimum": 1
            }
          },
          "required": ["activityId"],
          "additionalProperties": false
        },
        "status": {
          "type": "string",
          "enum": ["running", "completed", "aborted", "error"]
        },
        "returnedContext": {
          "type": "object",
          "additionalProperties": {}
        }
      },
      "required": ["workflowId", "triggeredAt", "triggeredFrom", "status"],
      "additionalProperties": false
    },
    "state": {
      "type": "object",
      "properties": {
        "workflowId": {
          "type": "string",
          "description": "ID of the workflow being executed"
        },
        "workflowVersion": {
          "type": "string",
          "description": "Version of the workflow"
        },
        "stateVersion": {
          "type": "integer",
          "exclusiveMinimum": 0,
          "default": 1,
          "description": "State schema version for migration support"
        },
        "startedAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "completedAt": {
          "type": "string",
          "format": "date-time"
        },
        "currentActivity": {
          "type": "string",
          "description": "Current activity ID"
        },
        "currentStep": {
          "type": "integer",
          "minimum": 1,
          "description": "Current step index within current activity (1-based)"
        },
        "completedActivities": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [],
          "description": "Array of completed activity IDs"
        },
        "skippedActivities": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": [],
          "description": "Array of skipped activity IDs"
        },
        "completedSteps": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "integer",
              "minimum": 1
            }
          },
          "default": {},
          "description": "Map of activity ID to array of completed step indices"
        },
        "checkpointResponses": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "optionId": {
                "type": "string",
                "description": "ID of the selected option"
              },
              "respondedAt": {
                "type": "string",
                "format": "date-time"
              },
              "effects": {
                "type": "object",
                "properties": {
                  "variablesSet": {
                    "type": "object",
                    "additionalProperties": {}
                  },
                  "transitionedTo": {
                    "type": "string",
                    "description": "Activity ID transitioned to"
                  },
                  "activitiesSkipped": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "additionalProperties": false
              }
            },
            "required": ["optionId", "respondedAt"],
            "additionalProperties": false,
            "description": "Key is 'activityId-checkpointId' (e.g., 'review-approve')"
          },
          "default": {}
        },
        "decisionOutcomes": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "branchId": {
                "type": "string",
                "description": "ID of the branch taken"
              },
              "decidedAt": {
                "type": "string",
                "format": "date-time"
              },
              "transitionedTo": {
                "type": "string",
                "description": "Activity ID transitioned to"
              }
            },
            "required": ["branchId", "decidedAt", "transitionedTo"],
            "additionalProperties": false,
            "description": "Key is 'activityId-decisionId'"
          },
          "default": {}
        },
        "activeLoops": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "activityId": {
                "type": "string",
                "description": "Activity containing this loop"
              },
              "loopId": {
                "type": "string",
                "description": "ID of the loop"
              },
              "currentIteration": {
                "type": "integer",
                "minimum": 0
              },
              "totalItems": {
                "type": "integer",
                "minimum": 0
              },
              "currentItem": {},
              "startedAt": {
                "type": "string",
                "format": "date-time"
              }
            },
            "required": ["activityId", "loopId", "currentIteration", "startedAt"],
            "additionalProperties": false
          },
          "default": []
        },
        "variables": {
          "type": "object",
          "additionalProperties": {},
          "default": {}
        },
        "history": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time"
              },
              "type": {
                "type": "string",
                "enum": [
                  "workflow_started",
                  "workflow_completed",
                  "workflow_aborted",
                  "workflow_triggered",
                  "workflow_returned",
                  "workflow_suspended",
                  "activity_entered",
                  "activity_exited",
                  "activity_skipped",
                  "step_started",
                  "step_completed",
                  "checkpoint_reached",
                  "checkpoint_response",
                  "decision_reached",
                  "decision_branch_taken",
                  "loop_started",
                  "loop_iteration",
                  "loop_completed",
                  "loop_break",
                  "variable_set",
                  "error"
                ]
              },
              "activity": {
                "type": "string",
                "description": "Activity ID"
              },
              "step": {
                "type": "integer",
                "minimum": 1,
                "description": "Step index within activity"
              },
              "checkpoint": {
                "type": "string",
                "description": "Checkpoint ID"
              },
              "decision": {
                "type": "string",
                "description": "Decision ID"
              },
              "loop": {
                "type": "string",
                "description": "Loop ID"
              },
              "data": {
                "type": "object",
                "additionalProperties": {}
              },
              "error": {
                "type": "object",
                "properties": {
                  "message": {
                    "type": "string"
                  },
                  "code": {
                    "type": "string"
                  }
                },
                "required": ["message"],
                "additionalProperties": false
              }
            },
            "required": ["timestamp", "type"],
            "additionalProperties": false
          },
          "default": []
        },
        "status": {
          "type": "string",
          "enum": ["running", "paused", "suspended", "completed", "aborted", "error"],
          "default": "running"
        },
        "parentWorkflow": {
          "$ref": "#/definitions/parentWorkflowRef",
          "description": "Reference to parent workflow if this was triggered"
        },
        "triggeredWorkflows": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/triggeredWorkflowRef"
          },
          "default": [],
          "description": "Child workflows triggered from this one"
        },
        "lastError": {
          "type": "object",
          "properties": {
            "message": {
              "type": "string"
            },
            "code": {
              "type": "string"
            },
            "activity": {
              "type": "string",
              "description": "Activity ID where error occurred"
            },
            "step": {
              "type": "integer",
              "minimum": 1,
              "description": "Step index where error occurred"
            },
            "timestamp": {
              "type": "string",
              "format": "date-time"
            }
          },
          "required": ["message", "timestamp"],
          "additionalProperties": false
        }
      },
      "required": ["workflowId", "workflowVersion", "startedAt", "updatedAt", "currentActivity"],
      "additionalProperties": false
    }
  }
}
