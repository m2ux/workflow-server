{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "activity",
  "description": "Unified activity definition schema - combines intent matching with workflow execution",
  "$ref": "#/definitions/activity",
  "definitions": {
    "action": {
      "type": "object",
      "properties": {
        "action": {
          "type": "string",
          "enum": ["log", "validate", "set", "emit"]
        },
        "target": {
          "type": "string"
        },
        "message": {
          "type": "string"
        },
        "value": {}
      },
      "required": ["action"],
      "additionalProperties": false
    },
    "step": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this step"
        },
        "name": {
          "type": "string",
          "description": "Human-readable step name"
        },
        "description": {
          "type": "string",
          "description": "Detailed guidance for executing this step"
        },
        "skill": {
          "type": "string",
          "description": "Skill ID to apply for this step"
        },
        "required": {
          "type": "boolean",
          "default": true
        },
        "actions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/action"
          }
        }
      },
      "required": ["id", "name"],
      "additionalProperties": false
    },
    "checkpointOption": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "label": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "effect": {
          "type": "object",
          "properties": {
            "setVariable": {
              "type": "object",
              "additionalProperties": {}
            },
            "transitionTo": {
              "type": "string",
              "description": "Activity ID to transition to"
            },
            "skipActivities": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Activity IDs to skip"
            }
          },
          "additionalProperties": false
        }
      },
      "required": ["id", "label"],
      "additionalProperties": false
    },
    "checkpoint": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "message": {
          "type": "string",
          "description": "Message to present to user at checkpoint"
        },
        "prerequisite": {
          "type": "string",
          "description": "Action to complete before presenting checkpoint"
        },
        "options": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/checkpointOption"
          },
          "minItems": 1
        },
        "required": {
          "type": "boolean",
          "default": true
        },
        "blocking": {
          "type": "boolean",
          "const": true,
          "default": true
        }
      },
      "required": ["id", "name", "message", "options"],
      "additionalProperties": false
    },
    "decisionBranch": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "label": {
          "type": "string"
        },
        "condition": {
          "$ref": "condition.schema.json"
        },
        "transitionTo": {
          "type": "string",
          "description": "Activity ID to transition to"
        },
        "isDefault": {
          "type": "boolean",
          "default": false
        }
      },
      "required": ["id", "label"],
      "additionalProperties": false
    },
    "decision": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "branches": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/decisionBranch"
          },
          "minItems": 2
        }
      },
      "required": ["id", "name", "branches"],
      "additionalProperties": false
    },
    "loop": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["forEach", "while", "doWhile"]
        },
        "variable": {
          "type": "string"
        },
        "over": {
          "type": "string"
        },
        "condition": {
          "$ref": "condition.schema.json"
        },
        "maxIterations": {
          "type": "integer",
          "exclusiveMinimum": 0,
          "default": 100
        },
        "breakCondition": {
          "$ref": "condition.schema.json"
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/step"
          }
        },
        "activities": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Activity IDs to execute in loop"
        }
      },
      "required": ["id", "name", "type"],
      "additionalProperties": false
    },
    "transition": {
      "type": "object",
      "properties": {
        "to": {
          "type": "string",
          "description": "Activity ID to transition to"
        },
        "condition": {
          "$ref": "condition.schema.json"
        },
        "isDefault": {
          "type": "boolean",
          "default": false
        }
      },
      "required": ["to"],
      "additionalProperties": false
    },
    "workflowTrigger": {
      "type": "object",
      "properties": {
        "workflow": {
          "type": "string",
          "description": "ID of the workflow to trigger"
        },
        "description": {
          "type": "string",
          "description": "Description of when/why this workflow is triggered"
        },
        "passContext": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Context variables to pass to the triggered workflow"
        }
      },
      "required": ["workflow"],
      "additionalProperties": false
    },
    "skills": {
      "type": "object",
      "properties": {
        "primary": {
          "type": "string",
          "description": "Primary skill ID for this activity"
        },
        "supporting": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Supporting skill IDs"
        }
      },
      "required": ["primary"],
      "additionalProperties": false
    },
    "activity": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the activity"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Semantic version of the activity"
        },
        "name": {
          "type": "string",
          "description": "Human-readable activity name"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the activity"
        },
        "problem": {
          "type": "string",
          "description": "Description of the user problem this activity addresses"
        },
        "recognition": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Patterns to match user intent to this activity"
        },
        "skills": {
          "$ref": "#/definitions/skills"
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/step"
          },
          "description": "Ordered execution steps for this activity"
        },
        "checkpoints": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/checkpoint"
          },
          "description": "Blocking user decision points"
        },
        "decisions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/decision"
          },
          "description": "Conditional branching points"
        },
        "loops": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/loop"
          },
          "description": "Iteration constructs"
        },
        "transitions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/transition"
          },
          "description": "Navigation to other activities"
        },
        "triggers": {
          "$ref": "#/definitions/workflowTrigger",
          "description": "Workflow to trigger from this activity"
        },
        "entryActions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/action"
          },
          "description": "Actions to execute when entering activity"
        },
        "exitActions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/action"
          },
          "description": "Actions to execute when exiting activity"
        },
        "outcome": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Expected outcomes when activity completes successfully"
        },
        "context_to_preserve": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Context items to preserve across the activity"
        },
        "required": {
          "type": "boolean",
          "default": true,
          "description": "Whether this activity is required in the workflow"
        },
        "estimatedTime": {
          "type": "string",
          "pattern": "^\\d+(-\\d+)?\\s*(m|min|h|hr|hours?|d|days?)?$",
          "description": "Estimated time to complete (e.g., '10-20m', '1h')"
        },
        "rules": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Activity-level rules and constraints that agents must follow"
        },
        "modeOverrides": {
          "type": "object",
          "description": "Mode-specific behavior overrides. Keys are mode IDs from workflow.modes",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "description": {
                "type": "string",
                "description": "Mode-specific activity description"
              },
              "rules": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Mode-specific rules and constraints"
              },
              "steps": {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/step"
                },
                "description": "Additional steps for this mode (merged with base steps)"
              },
              "skipSteps": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Step IDs to skip in this mode"
              },
              "checkpoints": {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/checkpoint"
                },
                "description": "Additional checkpoints for this mode"
              },
              "transitionOverride": {
                "type": "string",
                "description": "Override default transition target in this mode"
              },
              "context_to_preserve": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Additional context to preserve in this mode"
              }
            },
            "additionalProperties": false
          }
        }
      },
      "required": ["id", "version", "name", "skills"],
      "additionalProperties": true
    }
  }
}
