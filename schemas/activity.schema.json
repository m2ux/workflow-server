{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "activity",
  "description": "Unified activity definition schema - combines intent matching with workflow execution",
  "$ref": "#/definitions/activity",
  "definitions": {
    "action": {
      "type": "object",
      "properties": {
        "action": {
          "type": "string",
          "enum": ["log", "validate", "set", "emit", "message"],
          "description": "Action type: log (record message), validate (check a condition), set (assign a variable), emit (signal an event), message (display markdown content to the user)"
        },
        "target": {
          "type": "string",
          "description": "Target of the action (e.g., variable name for set, condition for validate)"
        },
        "message": {
          "type": "string",
          "description": "Message content for log actions or validation failure messages"
        },
        "value": {
          "description": "Value to assign (set) or emit"
        }
      },
      "required": ["action"],
      "additionalProperties": false
    },
    "step": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this step"
        },
        "name": {
          "type": "string",
          "description": "Human-readable step name"
        },
        "description": {
          "type": "string",
          "description": "Detailed guidance for executing this step"
        },
        "skill": {
          "type": "string",
          "description": "Skill ID to apply for this step"
        },
        "condition": {
          "$ref": "condition.schema.json",
          "description": "Condition that must be true for this step to execute. If false, the step is skipped."
        },
        "required": {
          "type": "boolean",
          "default": true
        },
        "actions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/action"
          }
        }
      },
      "required": ["id", "name"],
      "additionalProperties": false
    },
    "checkpointOption": {
      "type": "object",
      "description": "A selectable choice within a checkpoint",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this option"
        },
        "label": {
          "type": "string",
          "description": "Short label displayed to the user"
        },
        "description": {
          "type": "string",
          "description": "Detailed explanation of what this option does"
        },
        "effect": {
          "type": "object",
          "description": "Side effects triggered when the user selects this option",
          "properties": {
            "setVariable": {
              "type": "object",
              "additionalProperties": {},
              "description": "Variables to set when this option is selected (key-value pairs)"
            },
            "transitionTo": {
              "type": "string",
              "description": "Activity ID to transition to"
            },
            "skipActivities": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Activity IDs to skip"
            }
          },
          "additionalProperties": false
        }
      },
      "required": ["id", "label"],
      "additionalProperties": false
    },
    "checkpoint": {
      "type": "object",
      "description": "A blocking decision point that pauses execution and requires user input before continuing",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this checkpoint within the activity"
        },
        "name": {
          "type": "string",
          "description": "Human-readable checkpoint name"
        },
        "message": {
          "type": "string",
          "description": "Question or prompt to present to the user at this checkpoint"
        },
        "prerequisite": {
          "type": "string",
          "description": "Condition that must be true before presenting this checkpoint to the user. If not met, skip the checkpoint."
        },
        "options": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/checkpointOption"
          },
          "minItems": 1,
          "description": "Available choices for the user. Each option may trigger variable changes, transitions, or activity skips via its effect."
        },
        "required": {
          "type": "boolean",
          "default": true,
          "description": "Whether this checkpoint must be answered before proceeding"
        },
        "blocking": {
          "type": "boolean",
          "const": true,
          "default": true,
          "description": "Always true. Checkpoints pause workflow execution until the user responds."
        }
      },
      "required": ["id", "name", "message", "options"],
      "additionalProperties": false
    },
    "decisionBranch": {
      "type": "object",
      "description": "A conditional path within a decision point",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this branch"
        },
        "label": {
          "type": "string",
          "description": "Human-readable description of when this branch is taken"
        },
        "condition": {
          "$ref": "condition.schema.json"
        },
        "transitionTo": {
          "type": "string",
          "description": "Activity ID to transition to"
        },
        "isDefault": {
          "type": "boolean",
          "default": false
        }
      },
      "required": ["id", "label"],
      "additionalProperties": false
    },
    "decision": {
      "type": "object",
      "description": "An automated branching point that evaluates conditions without user input (unlike checkpoints which require user choice)",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this decision"
        },
        "name": {
          "type": "string",
          "description": "Human-readable decision name"
        },
        "description": {
          "type": "string",
          "description": "What is being decided"
        },
        "branches": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/decisionBranch"
          },
          "minItems": 2
        }
      },
      "required": ["id", "name", "branches"],
      "additionalProperties": false
    },
    "loop": {
      "type": "object",
      "description": "An iteration construct that repeats steps or activities. forEach iterates over a collection; while/doWhile repeat on a condition.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this loop"
        },
        "name": {
          "type": "string",
          "description": "Human-readable loop name"
        },
        "type": {
          "type": "string",
          "enum": ["forEach", "while", "doWhile"],
          "description": "Loop type: forEach (iterate over collection), while (check condition before each iteration), doWhile (execute then check condition)"
        },
        "variable": {
          "type": "string",
          "description": "Name of the iteration variable that holds the current item (forEach) or loop counter"
        },
        "over": {
          "type": "string",
          "description": "Collection or variable name to iterate over (forEach only, e.g., 'plan.tasks')"
        },
        "condition": {
          "$ref": "condition.schema.json",
          "description": "Condition evaluated each iteration (while/doWhile only)"
        },
        "maxIterations": {
          "type": "integer",
          "exclusiveMinimum": 0,
          "default": 100,
          "description": "Safety limit to prevent infinite loops"
        },
        "breakCondition": {
          "$ref": "condition.schema.json",
          "description": "If true, exit the loop early regardless of the main condition"
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/step"
          }
        },
        "activities": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Activity IDs to execute in loop"
        }
      },
      "required": ["id", "name", "type"],
      "additionalProperties": false
    },
    "transition": {
      "type": "object",
      "properties": {
        "to": {
          "type": "string",
          "description": "Activity ID to transition to"
        },
        "condition": {
          "$ref": "condition.schema.json"
        },
        "isDefault": {
          "type": "boolean",
          "default": false
        }
      },
      "required": ["to"],
      "additionalProperties": false
    },
    "workflowTrigger": {
      "type": "object",
      "properties": {
        "workflow": {
          "type": "string",
          "description": "ID of the workflow to trigger"
        },
        "description": {
          "type": "string",
          "description": "Description of when/why this workflow is triggered"
        },
        "passContext": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Context variables to pass to the triggered workflow"
        }
      },
      "required": ["workflow"],
      "additionalProperties": false
    },
    "artifact": {
      "type": "object",
      "description": "An artifact produced or updated by this activity",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this artifact within the activity"
        },
        "name": {
          "type": "string",
          "description": "Artifact filename without activity prefix. The activity's artifactPrefix is prepended at write time (e.g., name 'code-review.md' with artifactPrefix '08' produces '08-code-review.md'). May contain other template variables (e.g., '{n}' for iteration count, '{decision-title}' for ADR naming)."
        },
        "location": {
          "type": "string",
          "description": "Key into workflow.artifactLocations (e.g., 'planning', 'reviews', 'adr') or an explicit path"
        },
        "description": {
          "type": "string",
          "description": "What this artifact contains and its purpose"
        },
        "action": {
          "type": "string",
          "enum": ["create", "update"],
          "default": "create",
          "description": "Whether this activity creates a new artifact or updates an existing one"
        }
      },
      "required": ["id", "name"],
      "additionalProperties": false
    },
    "skills": {
      "type": "object",
      "properties": {
        "primary": {
          "type": "string",
          "description": "Primary skill ID for this activity"
        },
        "supporting": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Supporting skill IDs"
        }
      },
      "required": ["primary"],
      "additionalProperties": false
    },
    "activity": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the activity"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Semantic version of the activity"
        },
        "name": {
          "type": "string",
          "description": "Human-readable activity name"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the activity"
        },
        "problem": {
          "type": "string",
          "description": "Description of the user problem this activity addresses"
        },
        "recognition": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Patterns to match user intent to this activity"
        },
        "skills": {
          "$ref": "#/definitions/skills",
          "description": "Skill references. Load the primary skill via get_skill to get execution protocol, tool guidance, and rules."
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/step"
          },
          "description": "Ordered execution steps for this activity"
        },
        "checkpoints": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/checkpoint"
          },
          "description": "Blocking user decision points"
        },
        "decisions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/decision"
          },
          "description": "Conditional branching points"
        },
        "loops": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/loop"
          },
          "description": "Iteration constructs"
        },
        "artifactPrefix": {
          "type": "string",
          "description": "Numeric prefix prepended to all artifact filenames produced by this activity (e.g., '08'). Skills produce artifacts with bare names (e.g., 'code-review.md'); the activity prepends this prefix at write time (e.g., '08-code-review.md')."
        },
        "artifacts": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/artifact"
          },
          "description": "Artifacts produced or updated by this activity. Filenames in artifact.name are prepended with artifactPrefix when present. Location keys reference workflow.artifactLocations."
        },
        "transitions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/transition"
          },
          "description": "Navigation to other activities"
        },
        "triggers": {
          "$ref": "#/definitions/workflowTrigger",
          "description": "Workflow to trigger from this activity"
        },
        "entryActions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/action"
          },
          "description": "Actions to execute when entering activity"
        },
        "exitActions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/action"
          },
          "description": "Actions to execute when exiting activity"
        },
        "outcome": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Expected outcomes when activity completes successfully"
        },
        "context_to_preserve": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Context items to preserve across the activity"
        },
        "required": {
          "type": "boolean",
          "default": true,
          "description": "Whether this activity is required in the workflow"
        },
        "estimatedTime": {
          "type": "string",
          "pattern": "^\\d+(-\\d+)?\\s*(m|min|h|hr|hours?|d|days?)?$",
          "description": "Estimated time to complete (e.g., '10-20m', '1h')"
        },
        "rules": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Activity-level rules and constraints that agents MUST follow during this activity. Domain-specific rules are on the skill; sequencing rules are here."
        },
        "modeOverrides": {
          "type": "object",
          "description": "Mode-specific behavior overrides. Keys are mode IDs from workflow.modes",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "description": {
                "type": "string",
                "description": "Mode-specific activity description"
              },
              "rules": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Mode-specific rules and constraints"
              },
              "steps": {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/step"
                },
                "description": "Additional steps for this mode (merged with base steps)"
              },
              "skipSteps": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Step IDs to skip in this mode"
              },
              "checkpoints": {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/checkpoint"
                },
                "description": "Additional checkpoints for this mode"
              },
              "transitionOverride": {
                "type": "string",
                "description": "Override default transition target in this mode"
              },
              "context_to_preserve": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Additional context to preserve in this mode"
              }
            },
            "additionalProperties": false
          }
        }
      },
      "required": ["id", "version", "name", "skills"],
      "additionalProperties": true
    }
  }
}
